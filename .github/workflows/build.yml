name: Build BtRemote APK
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive # 强制拉取可能存在的子模块
          fetch-depth: 0        # 拉取完整历史

      - name: Debug File Structure
        run: |
          echo "--- 正在列出根目录文件 ---"
          ls -R
          echo "--- 正在全盘搜索 pubspec.yaml ---"
          find . -name "pubspec.yaml"

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'

      - name: Build Logic
        run: |
          # 手动指定你仓库里那个极深的路径
          # 根据你的 GitHub 显示，路径应该是：
          DIR="TCL-BtRemote/TCL-BtRemote/btremote_app"
          
          if [ -d "$DIR" ]; then
            cd "$DIR"
            flutter pub get
            cd android
            chmod +x gradlew
            ./gradlew assembleDefaultRelease
          else
            echo "错误：路径 $DIR 不存在！"
            echo "尝试自动进入第一个找到的目录..."
            AUTO_DIR=$(find . -name pubspec.yaml -exec dirname {} \; | head -n 1)
            if [ -n "$AUTO_DIR" ]; then
              cd "$AUTO_DIR"
              flutter pub get
              cd android && chmod +x gradlew && ./gradlew assembleDefaultRelease
            else
              echo "致命错误：全盘都找不到 pubspec.yaml！"
              exit 1
            fi
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: BtRemote-APK
          path: "**/*.apk"
